<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Revival Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
    #sidebar{width:220px;background:var(--panel);padding:16px 12px;display:flex;flex-direction:column;gap:8px}
    #brand{font-weight:700;margin-bottom:8px}
    .robux{margin-top:4px;font-size:.95rem;opacity:.9}
    .btn{width:100%;padding:10px;background:#1f2937;border:1px solid #243041;border-radius:10px;color:var(--text);cursor:pointer;text-align:left}
    .btn:hover{background:#222f43}
    #content{flex:1;padding:20px}
    .card{background:#0b1220;border:1px solid #1b2940;border-radius:14px;padding:16px;margin-bottom:16px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #263349;border-radius:10px;background:#0b1324;color:var(--text);margin:6px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
    .item{background:#111827;border:1px solid #243041;border-radius:12px;padding:12px;text-align:center;position:relative}
    .item img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px}
    .tag{position:absolute;top:8px;left:8px;font-size:.75rem;padding:2px 6px;border-radius:8px}
    .inline-btn{padding:6px 10px;border:1px solid #2b3953;border-radius:8px;background:#182339;color:var(--text);cursor:pointer}
    .inline-btn:hover{background:#1b2740}
    .hidden{display:none}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2b3953;border-radius:999px;font-size:.8rem;margin-left:6px}
    .muted{color:var(--muted)}
    #adminPanel{position:fixed;inset:60px 8% auto 8%;background:#0b1220;border:1px solid #1e2b43;border-radius:14px;padding:16px;z-index:50;display:none;max-height:80vh;overflow:auto}
    #closeAdmin{position:absolute;top:10px;right:10px}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .list{border:1px solid #1b2940;border-radius:12px;padding:10px;max-height:300px;overflow:auto}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kbd{padding:2px 6px;border:1px solid #2b3953;border-radius:6px;background:#0d172a;font-size:.8rem}
    .idbox{font-size:.7rem;opacity:.7;margin-top:4px}
  </style>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <aside id="sidebar">
    <div id="brand">Revival Hub</div>

    <div id="userBox" class="card">
      <div id="authBox">
        <input id="user" placeholder="Usuario">
        <input id="pass" placeholder="Contrase√±a" type="password">
        <div class="grid" style="grid-template-columns:1fr 1fr">
          <button class="btn" onclick="register()">Registrar</button>
          <button class="btn" onclick="login()">Login</button>
        </div>
      </div>
      <div id="sessionBox" class="hidden">
        <div>Hola, <b id="who"></b><span id="adminTag" class="pill hidden">ADMIN</span></div>
        <div class="robux">üí∞ Robux: <b id="robux">0</b></div>
        <div style="margin-top:8px">
          <button class="btn" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>

    <button class="btn" onclick="loadMarket()">Marketplace</button>
    <button class="btn" onclick="loadProfile()">Profile</button>
    <button class="btn" onclick="loadPromocodes()">Promocodes</button>
    <button class="btn" onclick="loadTradeos()">Tradeos</button>
    <button class="btn" onclick="loadFriends()">Friends</button>

    <div class="card" style="margin-top:auto">
      <div class="muted">Tip admin: abre panel con <span class="kbd">Insert</span></div>
    </div>
  </aside>

  <main id="content">
    <div class="card">
      <h2>Bienvenido a Revival Hub</h2>
      <p class="muted">Reg√≠strate o inicia sesi√≥n para empezar.</p>
    </div>
  </main>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <button id="closeAdmin" class="inline-btn" onclick="toggleAdmin(false)">Cerrar</button>
    <h2>Admin Panel</h2>

    <div class="card">
      <h3>Banear jugador</h3>
      <input id="banUser" placeholder="Usuario a banear">
      <input id="banReason" placeholder="Raz√≥n">
      <textarea id="banMsg" placeholder="Mensaje para el jugador"></textarea>
      <button class="inline-btn" onclick="banUser()">Banear</button>
    </div>

    <div class="card">
      <h3>Dar Robux</h3>
      <input id="giveUser" placeholder="Usuario destino">
      <input id="giveAmount" type="number" placeholder="Cantidad de Robux">
      <button class="inline-btn" onclick="adminGiveRobux()">Enviar</button>
    </div>

    <div class="card">
      <h3>Subir √≠tem al Marketplace</h3>
      <input id="itName" placeholder="Nombre del √≠tem">
      <input id="itImg" placeholder="URL de imagen">
      <input id="itPrice" type="number" placeholder="Precio">
      <input id="itStock" type="number" placeholder="Stock">
      <input id="itTagText" placeholder="Tag (texto opcional)">
      <input id="itTagColor" placeholder="Color texto del tag (ej: #fff)">
      <input id="itTagBg" placeholder="Color fondo del tag (ej: #22c55e)">
      <button class="inline-btn" onclick="addItem()">Publicar √≠tem</button>
    </div>

    <div class="card">
      <h3>Eliminar √≠tem del Marketplace</h3>
      <input id="delItemId" placeholder="ID del √≠tem">
      <button class="inline-btn" onclick="removeItem()">Eliminar</button>
    </div>
  </div>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser=null;
    function $(id){return document.getElementById(id);}

    // === Registro/Login simplificados (igual que antes) ===
    async function register(){/* ... igual a antes ... */}
    async function login(){/* ... igual a antes ... */}
    async function logout(){/* ... igual a antes ... */}
    async function startApp(){/* ... igual a antes ... */}
    async function updateRobux(){/* ... igual a antes ... */}

    // === Marketplace con ID visible para ROBLOX ===
    async function loadMarket(){
      const c=$("content");
      c.innerHTML=`<div class="card"><h2>Marketplace</h2><div id="marketGrid" class="grid">Cargando‚Ä¶</div></div>`;
      const q=await db.collection("items").orderBy("ts","desc").get();
      const grid=$("marketGrid");grid.innerHTML="";
      if(q.empty){grid.innerHTML="<div class='muted'>No hay √≠tems a√∫n</div>";return;}
      q.forEach(doc=>{
        const it=doc.data(),id=doc.id;
        const tag=it.tag?`<span class="tag" style="color:${it.tag.color};background:${it.tag.bg}">${it.tag.text}</span>`:"";
        grid.innerHTML+=`
          <div class="item">
            ${tag}
            <img src="${it.img||""}">
            <b>${it.name||"-"}</b>
            <div>${it.price||0} üí∞ ¬∑ Stock: <span id="stock_${id}">${it.stock||0}</span></div>
            ${currentUser==="ROBLOX"?`<div class="idbox">ID: ${id}</div>`:""}
            <button class="inline-btn" onclick="buyItem('${id}')">Comprar</button>
          </div>`;
      });
    }

    // === Fix enviar tradeo ===
    async function sendTrade(friend){
      const offered=Array.from(document.querySelectorAll('input[name="offer"]:checked')).map(i=>i.value);
      const requested=Array.from(document.querySelectorAll('input[name="request"]:checked')).map(i=>i.value);
      if(offered.length===0)return alert("Debes ofrecer al menos 1 √≠tem");

      const offeredObjs=[];for(const id of offered){
        const d=await db.collection("users").doc(currentUser).collection("inventory").doc(id).get();
        if(d.exists)offeredObjs.push({owner:currentUser,docId:id,data:d.data()});
      }
      const requestedObjs=[];for(const id of requested){
        const d=await db.collection("users").doc(friend).collection("inventory").doc(id).get();
        if(d.exists)requestedObjs.push({owner:friend,docId:id,data:d.data()});
      }
      await db.collection("trades").add({
        from:currentUser,to:friend,offered:offeredObjs,requested:requestedObjs,status:"pending",ts:Date.now()
      });
      alert("Tradeo enviado");loadTradeos();
    }

    // === Admin eliminar √≠tem ===
    async function removeItem(){
      if(currentUser!=="ROBLOX")return alert("Solo admin");
      const id=$("delItemId").value.trim();
      if(!id)return alert("Ingresa el ID del √≠tem");
      const ref=db.collection("items").doc(id);
      const snap=await ref.get();
      if(!snap.exists)return alert("√çtem no encontrado");
      await ref.delete();
      alert("√çtem eliminado del Marketplace");
    }
  </script>
</body>
</html>
