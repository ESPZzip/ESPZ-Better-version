<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Revival Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#334155;--text:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
    #sidebar{width:220px;background:var(--panel);padding:16px 12px;display:flex;flex-direction:column;gap:8px}
    #brand{font-weight:700;letter-spacing:.5px;margin-bottom:8px}
    .robux{margin-top:6px;font-size:.95rem;opacity:.9}
    .btn{width:100%;padding:10px 12px;background:#1f2937;border:1px solid #243041;border-radius:10px;color:var(--text);cursor:pointer;text-align:left}
    .btn:hover{background:#222f43}
    #content{flex:1;padding:20px}
    .card{background:#0b1220;border:1px solid #1b2940;border-radius:14px;padding:16px;margin-bottom:16px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #263349;border-radius:10px;background:#0b1324;color:var(--text);margin:6px 0}
    label{font-size:.9rem;opacity:.9}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .item{background:#0b1220;border:1px solid #22304a;border-radius:12px;padding:10px}
    .item img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    .tag{display:inline-block;font-size:.75rem;margin:6px 0;padding:2px 6px;border-radius:6px}
    .muted{color:#9ca3af}
    .hidden{display:none}
    #adminPanel{position:fixed;inset:60px 10% auto 10%;background:#0b1220;border:1px solid #1e2b43;border-radius:14px;padding:16px;z-index:50;display:none;max-height:80vh;overflow:auto}
    .inline-btn{padding:6px 10px;border:1px solid #2b3953;border-radius:8px;background:#182339;color:var(--text);cursor:pointer}
    .inline-btn:hover{background:#1b2740}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2b3953;border-radius:999px;font-size:.8rem;margin-left:6px}
  </style>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <aside id="sidebar">
    <div id="brand">Revival Hub</div>
    <div id="userBox" class="card">
      <div id="authBox">
        <input id="user" placeholder="Usuario">
        <input id="pass" placeholder="Contrase√±a" type="password">
        <div class="row">
          <button class="btn" onclick="register()">Registrar</button>
          <button class="btn" onclick="login()">Login</button>
        </div>
      </div>
      <div id="sessionBox" class="hidden">
        <div>Hola, <b id="who"></b><span id="adminTag" class="pill hidden">ADMIN</span></div>
        <div class="robux">üí∞ Robux: <b id="robux">0</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>

    <button class="btn" onclick="loadMarket()">Marketplace</button>
    <button class="btn" onclick="loadProfile()">Profile</button>
    <button class="btn" onclick="loadPromocodes()">Promocodes</button>
    <button class="btn" onclick="loadTradeos()">Tradeos</button>
    <button class="btn" onclick="loadFriends()">Friends</button>

    <div id="adminHint" class="card hidden">
      <div class="muted">Cuenta ROBLOX: presiona <b>Insert</b> para abrir Admin Panel.</div>
    </div>
  </aside>

  <main id="content">
    <div class="card">
      <h2>Bienvenido a Revival Hub</h2>
      <p class="muted">Reg√≠strate o inicia sesi√≥n para empezar.</p>
    </div>
  </main>

  <!-- Admin Panel (solo ROBLOX con tecla Insert) -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <div class="row">
      <div class="col card">
        <h3>Banear / Desbanear</h3>
        <label>Usuario</label>
        <input id="banUser" placeholder="usuario">
        <label>Raz√≥n</label>
        <input id="banReason" placeholder="Raz√≥n del ban">
        <label>Mensaje</label>
        <textarea id="banMsg" placeholder="Mensaje que ver√° el jugador"></textarea>
        <div class="row">
          <button class="inline-btn" style="border-color:#6b1d1d;background:#2b1a1a" onclick="banUserAction(true)">Banear</button>
          <button class="inline-btn" onclick="banUserAction(false)">Quitar ban</button>
        </div>
      </div>
      <div class="col card">
        <h3>Dar Robux</h3>
        <label>Usuario</label>
        <input id="giftUser" placeholder="usuario">
        <label>Monto</label>
        <input id="giftAmount" type="number" placeholder="ej: 100">
        <label>Mensaje</label>
        <input id="giftMsg" placeholder="mensaje (opcional)">
        <button class="inline-btn" onclick="adminGiveRobux()">Enviar</button>
      </div>
    </div>

    <div class="card">
      <h3>Subir Item a Marketplace</h3>
      <div class="row">
        <div class="col">
          <label>Nombre</label><input id="itName">
          <label>Imagen (URL)</label><input id="itImg">
          <label>Precio (Robux)</label><input id="itPrice" type="number">
        </div>
        <div class="col">
          <label>Valor</label><input id="itValue" type="number" placeholder="ej: 10">
          <label>Stock</label><input id="itStock" type="number" placeholder="ej: 5">
          <label>Subido por</label><input id="itAddedBy" placeholder="se guarda tu nombre por default">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>Tag texto</label><input id="tagText" placeholder="Limited, Featured, etc">
        </div>
        <div class="col">
          <label>Tag color texto</label><input id="tagColor" placeholder="#fff o 'red'">
        </div>
        <div class="col">
          <label>Tag color fondo</label><input id="tagBg" placeholder="#111 o 'gold'">
        </div>
      </div>
      <button class="inline-btn" onclick="adminAddItem()">Publicar item</button>
    </div>
  </div>

  <script>
    /* ================= Firebase ================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ================ Estado global ================ */
    let currentUser = null;

    /* ================ Auth ================ */
    async function register(){
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value;
      if(!u || !p) return alert("Completa usuario y contrase√±a");
      const ref = db.collection('users').doc(u);
      const snap = await ref.get();
      if(snap.exists) return alert("Ese usuario ya existe");
      await ref.set({
        username:u, password:p, robux:100, friends:[], requests:[], redeemedCodes:[], banned:{status:false}
      });
      alert("Registro exitoso. Inicia sesi√≥n.");
    }

    async function login(){
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value;
      const ref = db.collection('users').doc(u);
      const snap = await ref.get();
      if(!snap.exists) return alert("Usuario no existe");
      const data = snap.data();
      if(data.banned?.status){
        return alert(`Tu cuenta est√° baneada.\nRaz√≥n: ${data.banned.reason||'-'}\nMensaje: ${data.banned.message||''}`);
      }
      if(data.password !== p) return alert("Contrase√±a incorrecta");
      currentUser = u;
      localStorage.setItem('currentUser',u);
      mountSessionUI();
      loadMarket();
      if(currentUser==="ROBLOX"){ document.getElementById('adminHint').classList.remove('hidden'); }
    }

    function logout(){
      localStorage.removeItem('currentUser');
      currentUser=null;
      location.reload();
    }

    function mountSessionUI(){
      document.getElementById('authBox').classList.add('hidden');
      document.getElementById('sessionBox').classList.remove('hidden');
      document.getElementById('who').innerText=currentUser;
      document.getElementById('adminTag').classList.toggle('hidden', currentUser!=="ROBLOX");
      updateRobux();
    }

    async function updateRobux(){
      if(!currentUser) return;
      const s = await db.collection('users').doc(currentUser).get();
      if(s.exists) document.getElementById('robux').innerText = s.data().robux || 0;
    }

    window.onload = async ()=>{
      const u = localStorage.getItem('currentUser');
      if(u){
        const s = await db.collection('users').doc(u).get();
        if(s.exists && !s.data().banned?.status){
          currentUser=u; mountSessionUI(); loadMarket();
          if(currentUser==="ROBLOX"){ document.getElementById('adminHint').classList.remove('hidden'); }
        } else {
          localStorage.removeItem('currentUser');
        }
      }
    };

    /* ================ Admin (ROBLOX, tecla Insert) ================ */
    document.addEventListener('keydown',e=>{
      if(e.key==='Insert' && currentUser==='ROBLOX'){
        const p = document.getElementById('adminPanel');
        p.style.display = (p.style.display==='block') ? 'none' : 'block';
      }
    });

    async function banUserAction(ban){
      if(currentUser!=='ROBLOX') return;
      const user = document.getElementById('banUser').value.trim();
      if(!user) return alert("Usuario?");
      const reason = document.getElementById('banReason').value;
      const message = document.getElementById('banMsg').value;
      const ref = db.collection('users').doc(user);
      const s = await ref.get();
      if(!s.exists) return alert("No existe ese usuario");
      await ref.update({ banned:{status:ban,reason,message} });
      alert(ban?"Usuario baneado":"Ban removido");
    }

    async function adminGiveRobux(){
      if(currentUser!=='ROBLOX') return;
      const user = document.getElementById('giftUser').value.trim();
      const amount = parseInt(document.getElementById('giftAmount').value||'0',10);
      if(!user || !amount) return alert("Usuario y monto v√°lidos");
      const ref = db.collection('users').doc(user);
      const s = await ref.get(); if(!s.exists) return alert("No existe");
      const newR = (s.data().robux||0)+amount;
      await ref.update({robux:newR});
      alert(`Enviado ${amount} Robux a ${user}`);
    }

    async function adminAddItem(){
      if(currentUser!=='ROBLOX') return;
      const name = document.getElementById('itName').value.trim();
      const img = document.getElementById('itImg').value.trim();
      const price = parseInt(document.getElementById('itPrice').value||'0',10);
      const value = parseInt(document.getElementById('itValue').value||'0',10);
      const stock = parseInt(document.getElementById('itStock').value||'0',10);
      const addedBy = document.getElementById('itAddedBy').value.trim() || currentUser;
      const tagText = document.getElementById('tagText').value.trim();
      const tagColor = document.getElementById('tagColor').value.trim()||'#fff';
      const tagBg = document.getElementById('tagBg').value.trim()||'#222';
      if(!name||!img||!price||!stock) return alert("Completa nombre, imagen, precio y stock");
      await db.collection('items').doc(name).set({
        name,img,price,value,stock,addedBy,
        tag: tagText?{text:tagText,color:tagColor,bg:tagBg}:null
      });
      alert("Item publicado");
      loadMarket();
    }

    /* ================ Marketplace ================ */
    async function loadMarket(){
      const cont = document.getElementById('content');
      cont.innerHTML = `<div class="card"><h2>Marketplace</h2><div id="mkGrid" class="grid"></div></div>`;
      const grid = document.getElementById('mkGrid');
      const snap = await db.collection('items').get();
      if(snap.empty){ grid.innerHTML = `<div class="muted">No hay items a√∫n.</div>`; return;}
      grid.innerHTML = '';
      snap.forEach(d=>{
        const it = d.data();
        grid.innerHTML += `
          <div class="item">
            ${it.tag?`<div class="tag" style="color:${it.tag.color};background:${it.tag.bg}">${it.tag.text}</div>`:''}
            <img src="${it.img}" alt="${it.name}">
            <div style="margin-top:6px"><b>${it.name}</b></div>
            <div class="muted">üí∞ ${it.price} | ‚≠ê ${it.value||0}</div>
            <div class="muted">Stock: <b>${it.stock||0}</b></div>
            <button class="inline-btn" onclick="buyItem('${d.id}')">Comprar</button>
          </div>
        `;
      });
    }

    async function buyItem(id){
      if(!currentUser) return alert("Inicia sesi√≥n");
      const itemRef = db.collection('items').doc(id);
      const itSnap = await itemRef.get();
      if(!itSnap.exists) return alert("Item no existe");
      const it = itSnap.data();
      const stock = Number(it.stock)||0;
      if(stock<=0) return alert("NO HAY STOCK");
      const uRef = db.collection('users').doc(currentUser);
      const uSnap = await uRef.get();
      const robux = Number(uSnap.data().robux)||0;
      const price = Number(it.price)||0;
      if(robux < price) return alert("Robux insuficientes");
      await uRef.update({robux: robux - price});
      await itemRef.update({stock: stock - 1});
      await db.collection('users').doc(currentUser).collection('inventory').add({
        name: it.name, img: it.img, value: it.value||0, source: 'purchase', timestamp: Date.now()
      });
      alert("¬°Comprado!");
      updateRobux(); loadMarket();
    }

    /* ================ Profile ================ */
    async function loadProfile(){
      if(!currentUser) return alert("Inicia sesi√≥n");
      const cont = document.getElementById('content');
      cont.innerHTML = `
        <div class="card">
          <h2>Profile</h2>
          <div class="row">
            <div class="col">
              <h3>Inventario</h3>
              <div id="invGrid" class="grid"></div>
            </div>
          </div>
        </div>`;
      const invGrid = document.getElementById('invGrid');
      const inv = await db.collection('users').doc(currentUser).collection('inventory').get();
      if(inv.empty){ invGrid.innerHTML = `<div class="muted">No tienes items.</div>`; return;}
      invGrid.innerHTML = '';
      inv.forEach(d=>{
        const it = d.data();
        invGrid.innerHTML += `
          <div class="item">
            <img src="${it.img}" alt="${it.name}">
            <div><b>${it.name}</b></div>
            <div class="muted">‚≠ê ${it.value||0}</div>
          </div>`;
      });
    }

    /* ================ Promocodes ================ */
    async function loadPromocodes(){
      if(!currentUser) return alert("Inicia sesi√≥n");
      const isAdmin = currentUser==='ROBLOX';
      const cont = document.getElementById('content');
      cont.innerHTML = `
        <div class="card">
          <h2>Promocodes</h2>
          <div class="row">
            <div class="col">
              <h3>Canjear c√≥digo</h3>
              <input id="redeemCode" placeholder="C√≥digo">
              <button class="inline-btn" onclick="redeemCode()">Canjear</button>
              <div id="redeemMsg" class="muted" style="margin-top:6px"></div>
            </div>
            ${isAdmin?`
            <div class="col">
              <h3>Crear c√≥digo (ROBLOX)</h3>
              <label>C√≥digo</label><input id="pcCode" placeholder="EJEMPLO2025">
              <label>Tipo</label>
              <select id="pcType">
                <option value="robux">Robux</option>
                <option value="item">Item</option>
              </select>
              <div id="pcRobuxBox">
                <label>Robux a dar</label><input id="pcAmount" type="number" placeholder="100">
              </div>
              <div id="pcItemBox" class="hidden">
                <label>Nombre item</label><input id="pcItemName">
                <label>Imagen item</label><input id="pcItemImg">
                <label>Valor item</label><input id="pcItemValue" type="number" placeholder="0">
              </div>
              <button class="inline-btn" onclick="createPromo()">Crear c√≥digo</button>
              <div class="muted" style="margin-top:6px">El c√≥digo se guarda en Firestore.</div>
            </div>`:''}
          </div>
        </div>`;
      // toggle tipo
      if(isAdmin){
        const sel = document.getElementById('pcType');
        sel.onchange = ()=>{
          document.getElementById('pcRobuxBox').classList.toggle('hidden', sel.value!=='robux');
          document.getElementById('pcItemBox').classList.toggle('hidden', sel.value!=='item');
        };
      }
    }

    async function createPromo(){
      if(currentUser!=='ROBLOX') return;
      const code = document.getElementById('pcCode').value.trim().toUpperCase();
      const type = document.getElementById('pcType').value;
      if(!code) return alert("C√≥digo?");
      const ref = db.collection('promocodes').doc(code);
      const s = await ref.get();
      if(s.exists) return alert("Ese c√≥digo ya existe");
      let payload = {active:true,type,createdBy:currentUser,createdAt:Date.now()};
      if(type==='robux'){
        const amount = parseInt(document.getElementById('pcAmount').value||'0',10);
        if(!amount) return alert("Robux a dar?");
        payload.amount = amount;
      }else{
        const name = document.getElementById('pcItemName').value.trim();
        const img = document.getElementById('pcItemImg').value.trim();
        const value = parseInt(document.getElementById('pcItemValue').value||'0',10);
        if(!name||!img) return alert("Completa nombre e imagen del item");
        payload.item = {name,img,value:value||0};
      }
      await ref.set(payload);
      alert("C√≥digo creado");
    }

    async function redeemCode(){
      if(!currentUser) return;
      const code = document.getElementById('redeemCode').value.trim().toUpperCase();
      const out = document.getElementById('redeemMsg');
      if(!code) return;
      const codeRef = db.collection('promocodes').doc(code);
      const c = await codeRef.get();
      if(!c.exists || !c.data().active) { out.innerText = "C√≥digo inv√°lido o inactivo."; return; }
      const uRef = db.collection('users').doc(currentUser);
      const u = await uRef.get();
      const redeemed = u.data().redeemedCodes||[];
      if(redeemed.includes(code)){ out.innerText="Ya canjeaste este c√≥digo."; return; }
      // aplicar recompensa
      if(c.data().type==='robux'){
        const robux = (u.data().robux||0) + (c.data().amount||0);
        await uRef.update({robux, redeemedCodes: [...redeemed, code]});
      }else{
        await uRef.collection('inventory').add({...c.data().item, source:'promocode', timestamp:Date.now()});
        await uRef.update({redeemedCodes: [...redeemed, code]});
      }
      out.innerText = "¬°C√≥digo canjeado!";
      updateRobux();
    }

    /* ================ Friends ================ */
    async function loadFriends(){
      if(!currentUser) return alert("Inicia sesi√≥n");
      const cont = document.getElementById('content');
      cont.innerHTML = `
        <div class="card">
          <h2>Friends</h2>
          <div class="row">
            <div class="col">
              <h3>Agregar amigo</h3>
              <input id="friendName" placeholder="Usuario a agregar">
              <button class="inline-btn" onclick="sendFriendRequest()">Enviar solicitud</button>
            </div>
            <div class="col">
              <h3>Solicitudes recibidas</h3>
              <div id="reqList" class="muted">Cargando‚Ä¶</div>
            </div>
            <div class="col">
              <h3>Tus amigos</h3>
              <div id="friendsList" class="muted">Cargando‚Ä¶</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Ver inventario de un amigo</h3>
          <input id="viewFriend" placeholder="Usuario amigo">
          <button class="inline-btn" onclick="viewFriendInventory()">Ver inventario</button>
          <div id="friendInv" class="grid" style="margin-top:10px"></div>
        </div>
        <div class="card">
          <h3>Regalar Robux a un amigo</h3>
          <div class="row">
            <div class="col"><input id="giftTo" placeholder="Usuario amigo"></div>
            <div class="col"><input id="giftRobux" type="number" placeholder="Monto"></div>
            <div class="col"><input id="giftNote" placeholder="Mensaje (opcional)"></div>
            <div class="col"><button class="inline-btn" onclick="giftToFriend()">Regalar</button></div>
          </div>
        </div>`;
      renderRequestsAndFriends();
    }

    async function sendFriendRequest(){
      const target = document.getElementById('friendName').value.trim();
      if(!target || target===currentUser) return alert("Nombre inv√°lido");
      const tRef = db.collection('users').doc(target);
      const t = await tRef.get(); if(!t.exists) return alert("Ese usuario no existe");
      const reqs = t.data().requests||[];
      const already = (reqs||[]).find(r=>r===currentUser);
      if(already) return alert("Ya enviaste solicitud");
      await tRef.update({requests: [...reqs, currentUser]});
      alert("Solicitud enviada");
    }

    async function renderRequestsAndFriends(){
      const uRef = db.collection('users').doc(currentUser);
      const u = await uRef.get();
      const reqList = document.getElementById('reqList');
      const frList = document.getElementById('friendsList');
      const reqs = u.data().requests||[];
      const friends = u.data().friends||[];
      reqList.innerHTML = reqs.length? reqs.map(r=>`
        <div>${r}
          <button class="inline-btn" onclick="acceptReq('${r}')">Aceptar</button>
          <button class="inline-btn" onclick="rejectReq('${r}')">Rechazar</button>
        </div>`).join('') : 'Sin solicitudes';
      frList.innerHTML = friends.length? friends.map(f=>`<div>${f}</div>`).join('') : 'A√∫n sin amigos';
    }

    async function acceptReq(from){
      const meRef = db.collection('users').doc(currentUser);
      const frRef = db.collection('users').doc(from);
      const me = await meRef.get(); const fr = await frRef.get();
      const myReqs = (me.data().requests||[]).filter(x=>x!==from);
      const myFriends = new Set(me.data().friends||[]); myFriends.add(from);
      const frFriends = new Set(fr.data().friends||[]); frFriends.add(currentUser);
      await meRef.update({requests:[...myReqs], friends:[...myFriends]});
      await frRef.update({friends:[...frFriends]});
      renderRequestsAndFriends();
    }

    async function rejectReq(from){
      const meRef = db.collection('users').doc(currentUser);
      const me = await meRef.get();
      const myReqs = (me.data().requests||[]).filter(x=>x!==from);
      await meRef.update({requests: myReqs});
      renderRequestsAndFriends();
    }

    async function viewFriendInventory(){
      const f = document.getElementById('viewFriend').value.trim();
      if(!f) return;
      const me = await db.collection('users').doc(currentUser).get();
      const friends = me.data().friends||[];
      if(!friends.includes(f)) return alert("Ese usuario no es tu amigo");
      const inv = await db.collection('users').doc(f).collection('inventory').get();
      const grid = document.getElementById('friendInv');
      if(inv.empty){ grid.innerHTML = `<div class="muted">Tu amigo no tiene √≠tems.</div>`; return;}
      grid.innerHTML = '';
      inv.forEach(d=>{
        const it = d.data();
        grid.innerHTML += `
          <div class="item">
            <img src="${it.img}" alt="${it.name}">
            <div><b>${it.name}</b></div>
            <div class="muted">‚≠ê ${it.value||0}</div>
          </div>`;
      });
    }

    async function giftToFriend(){
      const to = document.getElementById('giftTo').value.trim();
      const amount = parseInt(document.getElementById('giftRobux').value||'0',10);
      if(!to || !amount) return alert("Completa usuario y monto");
      const meRef = db.collection('users').doc(currentUser);
      const me = await meRef.get();
      if((me.data().robux||0) < amount) return alert("No tienes suficientes Robux");
      const toRef = db.collection('users').doc(to);
      const toS = await toRef.get(); if(!toS.exists) return alert("Ese usuario no existe");
      await meRef.update({robux: (me.data().robux||0)-amount});
      await toRef.update({robux: (toS.data().robux||0)+amount});
      updateRobux();
      alert(`Enviados ${amount} Robux a ${to}`);
    }

    /* ================ Tradeos (entre amigos) ================ */
    async function loadTradeos(){
      if(!currentUser) return alert("Inicia sesi√≥n");
      const cont = document.getElementById('content');
      cont.innerHTML = `
        <div class="card">
          <h2>Tradeos</h2>
          <div class="row">
            <div class="col">
              <h3>Enviar trade a un amigo</h3>
              <input id="tradeTarget" placeholder="Usuario amigo">
              <div id="myInv" class="grid" style="margin-top:10px"></div>
              <button class="inline-btn" onclick="sendTrade()">Enviar Trade</button>
            </div>
            <div class="col">
              <h3>Trades recibidos</h3>
              <div id="recTrades">Cargando‚Ä¶</div>
            </div>
          </div>
        </div>`;
      // cargar inventario propio con checks
      const inv = await db.collection('users').doc(currentUser).collection('inventory').get();
      const myInv = document.getElementById('myInv');
      myInv.innerHTML = inv.empty? `<div class="muted">No tienes √≠tems.</div>` : '';
      inv.forEach(d=>{
        const it=d.data();
        myInv.innerHTML += `
          <label class="item" style="display:block">
            <input type="checkbox" class="tradePick" value="${d.id}">
            <div style="display:flex;gap:10px;align-items:center">
              <img src="${it.img}" style="width:64px;height:64px;object-fit:cover;border-radius:8px">
              <div><b>${it.name}</b><div class="muted">‚≠ê ${it.value||0}</div></div>
            </div>
          </label>`;
      });
      renderReceivedTrades();
    }

    async function sendTrade(){
      const target = document.getElementById('tradeTarget').value.trim();
      if(!target) return alert("Elige un amigo");
      // verificar que sea amigo
      const me = await db.collection('users').doc(currentUser).get();
      if(!(me.data().friends||[]).includes(target)) return alert("Solo puedes tradear con amigos");
      const picks = [...document.querySelectorAll('.tradePick:checked')].map(i=>i.value);
      if(picks.length===0) return alert("Elige al menos un √≠tem");
      // cargar data de cada pick
      let items=[];
      for(const id of picks){
        const s = await db.collection('users').doc(currentUser).collection('inventory').doc(id).get();
        if(s.exists) items.push({id, ...s.data()});
      }
      await db.collection('users').doc(target).collection('trades').add({
        from: currentUser, items, ts: Date.now()
      });
      alert("Trade enviado");
      loadTradeos();
    }

    async function renderReceivedTrades(){
      const box = document.getElementById('recTrades');
      const s = await db.collection('users').doc(currentUser).collection('trades').get();
      if(s.empty){ box.innerHTML = `<div class="muted">Sin trades pendientes.</div>`; return; }
      box.innerHTML = '';
      s.forEach(d=>{
        const t = d.data();
        let list = t.items.map(it=>`${it.name} (‚≠ê${it.value||0})`).join(', ');
        box.innerHTML += `
          <div class="card">
            <div><b>De:</b> ${t.from}</div>
            <div class="muted">Items: ${list}</div>
            <div style="margin-top:8px">
              <button class="inline-btn" onclick="acceptTrade('${d.id}','${t.from}')">Aceptar</button>
              <button class="inline-btn" onclick="rejectTrade('${d.id}')">Rechazar</button>
            </div>
          </div>`;
      });
    }

    async function acceptTrade(tradeId, from){
      const tRef = db.collection('users').doc(currentUser).collection('trades').doc(tradeId);
      const t = await tRef.get(); if(!t.exists) return;
      const trade = t.data();
      // Transferir: quitar de from, agregar a currentUser
      for(const it of trade.items){
        // eliminar en origen
        await db.collection('users').doc(from).collection('inventory').doc(it.id).delete();
        // agregar en destino
        await db.collection('users').doc(currentUser).collection('inventory').add({
          name: it.name, img: it.img, value: it.value||0, source:'trade', from, timestamp: Date.now()
        });
      }
      await tRef.delete();
      alert("Trade aceptado");
      renderReceivedTrades();
      if(document.getElementById('invGrid')) loadProfile();
    }

    async function rejectTrade(tradeId){
      await db.collection('users').doc(currentUser).collection('trades').doc(tradeId).delete();
      alert("Trade rechazado");
      renderReceivedTrades();
    }

    /* ================ Utilidades ================ */
    function htmlesc(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
  </script>
</body>
</html>
