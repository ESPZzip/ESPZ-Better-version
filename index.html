<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>XD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--text:#e5e7eb;--muted:#94a3b8}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
    #sidebar{width:220px;background:var(--panel);padding:16px 12px;display:flex;flex-direction:column;gap:8px}
    #brand{font-weight:700;margin-bottom:8px}
    .robux{margin-top:4px;font-size:.95rem;opacity:.9}
    .btn{width:100%;padding:10px;background:#1f2937;border:1px solid #243041;border-radius:10px;color:var(--text);cursor:pointer;text-align:left}
    .btn:hover{background:#222f43}
    #content{flex:1;padding:20px}
    .card{background:#0b1220;border:1px solid #1b2940;border-radius:14px;padding:16px;margin-bottom:16px}
    .hidden{display:none}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2b3953;border-radius:999px;font-size:.8rem;margin-left:6px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
    .item{background:#111827;border:1px solid #243041;border-radius:12px;padding:12px;text-align:center;position:relative}
    .item img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px}
    .tag{position:absolute;top:8px;left:8px;font-size:.75rem;padding:2px 6px;border-radius:8px}
    .inline-btn{padding:6px 10px;border:1px solid #2b3953;border-radius:8px;background:#182339;color:var(--text);cursor:pointer}
    .inline-btn:hover{background:#1b2740}
    /* Toasts */
    #toasts{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999}
    .toast{background:#1f2937;color:#fff;padding:10px 16px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.3);animation:fadein .3s}
    @keyframes fadein{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
    /* Admin Panel */
    #adminPanel{position:fixed;top:60px;left:10%;right:10%;background:#0b1220;border:1px solid #1e2b43;border-radius:14px;padding:16px;z-index:100;display:none;max-height:80vh;overflow:auto}
    #closeAdmin{position:absolute;top:10px;right:10px}
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <aside id="sidebar">
    <div id="brand">Revival Hub</div>
    <div id="userBox" class="card">
      <div id="authBox">
        <input id="user" placeholder="Usuario">
        <input id="pass" placeholder="Contrase√±a" type="password">
        <div class="row">
          <button class="btn" onclick="register()">Registrar</button>
          <button class="btn" onclick="login()">Login</button>
        </div>
      </div>
      <div id="sessionBox" class="hidden">
        <div>Hola, <b id="who"></b><span id="adminTag" class="pill hidden">ADMIN</span></div>
        <div class="robux">üí∞ Robux: <b id="robux">0</b></div>
        <div style="margin-top:8px"><button class="btn" onclick="logout()">Cerrar sesi√≥n</button></div>
      </div>
    </div>
    <button class="btn" onclick="loadMarket()">Marketplace</button>
    <button class="btn" onclick="loadProfile()">Profile</button>
    <button class="btn" onclick="loadPromocodes()">Promocodes</button>
    <button class="btn" onclick="loadTradeos()">Tradeos</button>
    <button class="btn" onclick="loadFriends()">Friends</button>
  </aside>

  <main id="content">
    <div class="card"><h2>Bienvenido a Revival Hub</h2><p class="muted">Reg√≠strate o inicia sesi√≥n para empezar.</p></div>
  </main>

  <div id="toasts"></div>

  <!-- Panel Admin -->
  <div id="adminPanel">
    <button id="closeAdmin" class="inline-btn" onclick="toggleAdmin(false)">Cerrar</button>
    <h2>Admin Panel</h2>
    <div class="card">
      <h3>Crear √≠tem en Marketplace</h3>
      <input id="itName" placeholder="Nombre del √≠tem">
      <input id="itImg" placeholder="URL de la imagen">
      <input id="itPrice" type="number" placeholder="Precio">
      <input id="itStock" type="number" placeholder="Stock">
      <input id="itTagText" placeholder="Texto del tag (opcional)">
      <input id="itTagColor" placeholder="Color del texto (ej: #fff)">
      <input id="itTagBg" placeholder="Fondo del tag (ej: #22c55e)">
      <button class="inline-btn" onclick="addItem()">Publicar √≠tem</button>
    </div>
  </div>

  <script>
    const firebaseConfig={apiKey:"AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",authDomain:"pekora-forum.firebaseapp.com",projectId:"pekora-forum"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    let currentUser=null;
    function $(id){return document.getElementById(id);}
    function showToast(msg){const box=$("toasts");const t=document.createElement("div");t.className="toast";t.innerText=msg;box.appendChild(t);setTimeout(()=>t.remove(),4000);}

    // ===== Registro/Login =====
    async function register(){
      const u=$("user").value.trim(), p=$("pass").value.trim();
      if(!u||!p)return alert("Faltan datos");
      const ref=db.collection("users").doc(u);
      if((await ref.get()).exists)return alert("Usuario ya existe");
      await ref.set({pass:p,robux:100,friends:[],inventory:[]});
      localStorage.setItem("session",u);
      startApp(u);
    }
    async function login(){
      const u=$("user").value.trim(), p=$("pass").value.trim();
      const ref=db.collection("users").doc(u);
      const snap=await ref.get();
      if(!snap.exists)return alert("No existe usuario");
      if(snap.data().pass!==p)return alert("Contrase√±a incorrecta");
      localStorage.setItem("session",u);
      startApp(u);
    }
    function logout(){localStorage.removeItem("session");location.reload();}
    async function startApp(u){
      currentUser=u;
      $("authBox").classList.add("hidden");
      $("sessionBox").classList.remove("hidden");
      $("who").innerText=u;
      if(u==="ROBLOX")$("adminTag").classList.remove("hidden");
      updateRobux();
    }
    async function updateRobux(){
      const snap=await db.collection("users").doc(currentUser).get();
      if(snap.exists)$("robux").innerText=snap.data().robux||0;
    }
    window.onload=()=>{const s=localStorage.getItem("session");if(s)startApp(s);};

    // ===== Marketplace =====
    async function loadMarket(){
      $("content").innerHTML=`<div class="card"><h2>Marketplace</h2><div id="marketGrid" class="grid">Cargando‚Ä¶</div></div>`;
      const q=await db.collection("items").orderBy("ts","desc").get();
      const grid=$("marketGrid");grid.innerHTML="";
      if(q.empty){grid.innerHTML="<div class='muted'>No hay √≠tems a√∫n</div>";return;}
      q.forEach(doc=>{
        const it=doc.data(),id=doc.id;
        const tag=it.tag?`<span class="tag" style="color:${it.tag.color};background:${it.tag.bg}">${it.tag.text}</span>`:"";
        grid.innerHTML+=`
          <div class="item">
            ${tag}
            <img src="${it.img||""}">
            <b>${it.name||"-"}</b>
            <div>${it.price||0} üí∞ ¬∑ Stock: <span id="stock_${id}">${it.stock||0}</span></div>
            <button class="inline-btn" onclick="buyItem('${id}')">Comprar</button>
          </div>`;
      });
    }
    async function buyItem(id){
      const uref=db.collection("users").doc(currentUser);
      const iref=db.collection("items").doc(id);
      const user=await uref.get(), item=await iref.get();
      if(!user.exists||!item.exists)return;
      const udata=user.data(), idata=item.data();
      if(idata.stock<=0)return alert("No hay stock");
      if(udata.robux<idata.price)return alert("No tienes suficientes Robux");
      await uref.update({robux:udata.robux-idata.price});
      await iref.update({stock:idata.stock-1});
      await uref.collection("inventory").add(idata);
      showToast("‚úÖ Compraste "+idata.name);
      updateRobux();loadMarket();
    }

    // ===== Profile =====
    async function loadProfile(){
      $("content").innerHTML=`<div class="card"><h2>Profile</h2><div id="inv"></div></div>`;
      const q=await db.collection("users").doc(currentUser).collection("inventory").get();
      const inv=$("inv");inv.innerHTML="";
      if(q.empty){inv.innerHTML="<p class='muted'>Inventario vac√≠o</p>";return;}
      q.forEach(d=>{
        const it=d.data();
        inv.innerHTML+=`<div class="item"><img src="${it.img}"><b>${it.name}</b></div>`;
      });
    }

    // ===== Promocodes / Friends / Tradeos =====
    function loadPromocodes(){$("content").innerHTML=`<div class="card"><h2>Promocodes</h2><p>Canjea c√≥digos aqu√≠.</p></div>`;}
    function loadFriends(){$("content").innerHTML=`<div class="card"><h2>Friends</h2><p>Lista de amigos.</p></div>`;}
    async function loadTradeos(){
      $("content").innerHTML=`
        <div class="card">
          <h2>Tradeos</h2>
          <div class="cols">
            <div><h3>Entrantes</h3><div id="incoming" class="list">Cargando‚Ä¶</div></div>
            <div><h3>Salientes</h3><div id="outgoing" class="list">Cargando‚Ä¶</div></div>
          </div>
        </div>`;
      renderTrades();
    }
    function renderTrades(){
      const incBox=$("incoming"),outBox=$("outgoing");
      db.collection("trades").where("to","==",currentUser).onSnapshot(s=>{
        incBox.innerHTML="";
        if(s.empty){incBox.innerHTML="<div class='muted'>Sin trades</div>";return;}
        s.forEach(d=>{
          const t=d.data();
          incBox.innerHTML+=`<div class="card"><b>${t.from}</b> te mand√≥ un trade</div>`;
          if(!t.notified){showToast("üì© Nuevo tradeo recibido de "+t.from);db.collection("trades").doc(d.id).update({notified:true});}
        });
      });
      db.collection("trades").where("from","==",currentUser).onSnapshot(s=>{
        outBox.innerHTML="";
        if(s.empty){outBox.innerHTML="<div class='muted'>Sin trades</div>";return;}
        s.forEach(d=>{const t=d.data();outBox.innerHTML+=`<div class="card">Para <b>${t.to}</b> ¬∑ Estado: ${t.status}</div>`;});
      });
    }

    // ===== Admin Panel =====
    document.addEventListener("keydown",e=>{
      if(e.key==="Insert" && currentUser==="ROBLOX"){toggleAdmin(true);}
    });
    function toggleAdmin(show){$("adminPanel").style.display=show?"block":"none";}

    async function addItem(){
      if(currentUser!=="ROBLOX")return alert("Solo admin puede subir √≠tems");
      const name=$("itName").value.trim(), img=$("itImg").value.trim();
      const price=parseInt($("itPrice").value)||0;
      const stock=parseInt($("itStock").value)||0;
      const tagText=$("itTagText").value.trim(), tagColor=$("itTagColor").value.trim(), tagBg=$("itTagBg").value.trim();
      const item={name,img,price,stock,ts:Date.now()};
      if(tagText)item.tag={text:tagText,color:tagColor||"#fff",bg:tagBg||"#22c55e"};
      await db.collection("items").add(item);
      showToast("‚úÖ √çtem publicado en Marketplace");
      $("itName").value=$("itImg").value=$("itPrice").value=$("itStock").value=$("itTagText").value=$("itTagColor").value=$("itTagBg").value="";
    }
  </script>
</body>
</html>
