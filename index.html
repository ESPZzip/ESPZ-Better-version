<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--muted:#334155;--text:#e5e7eb;--acc:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
    #sidebar{width:220px;background:var(--panel);padding:16px 12px;display:flex;flex-direction:column;gap:8px}
    #brand{font-weight:700;letter-spacing:.5px;margin-bottom:8px}
    .robux{margin-top:4px;font-size:.95rem;opacity:.9}
    .btn{width:100%;padding:10px 12px;background:#1f2937;border:1px solid #243041;border-radius:10px;color:var(--text);cursor:pointer;text-align:left}
    .btn:hover{background:#222f43}
    #content{flex:1;padding:20px}
    .card{background:#0b1220;border:1px solid #1b2940;border-radius:14px;padding:16px;margin-bottom:16px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #263349;border-radius:10px;background:#0b1324;color:var(--text);margin:6px 0}
    label{font-size:.9rem;opacity:.9}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .item{background:#0b1220;border:1px solid #22304a;border-radius:12px;padding:10px}
    .item img{width:100%;height:120px;object-fit:cover;border-radius:8px}
    .tag{display:inline-block;font-size:.75rem;margin:6px 0;padding:2px 6px;border-radius:6px}
    .muted{color:#9ca3af}
    .danger{color:#ef4444}
    .ok{color:#22c55e}
    .hidden{display:none}
    #adminPanel{position:fixed;inset:60px 10% auto 10%;background:#0b1220;border:1px solid #1e2b43;border-radius:14px;padding:16px;z-index:50;display:none;max-height:80vh;overflow:auto}
    .inline-btn{padding:6px 10px;border:1px solid #2b3953;border-radius:8px;background:#182339;color:var(--text);cursor:pointer}
    .inline-btn:hover{background:#1b2740}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2b3953;border-radius:999px;font-size:.8rem;margin-left:6px}
  </style>
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <aside id="sidebar">
    <div id="brand">Revival Hub</div>
    <div id="userBox" class="card">
      <div id="authBox">
        <input id="user" placeholder="Usuario">
        <input id="pass" placeholder="Contrase√±a" type="password">
        <div class="row">
          <button class="btn" onclick="register()">Registrar</button>
          <button class="btn" onclick="login()">Login</button>
        </div>
      </div>
      <div id="sessionBox" class="hidden">
        <div>Hola, <b id="who"></b><span id="adminTag" class="pill hidden">ADMIN</span></div>
        <div class="robux">üí∞ Robux: <b id="robux">0</b></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>

    <button class="btn" onclick="loadMarket()">Marketplace</button>
    <button class="btn" onclick="loadProfile()">Profile</button>
    <button class="btn" onclick="loadPromocodes()">Promocodes</button>
    <button class="btn" onclick="loadTradeos()" id="btnTradeos">Tradeos</button>
    <button class="btn" onclick="loadFriends()">Friends</button>

    <div id="adminHint" class="card hidden">
      <div class="muted">Cuenta ROBLOX: presiona <b>Insert</b> para abrir Admin Panel.</div>
    </div>
  </aside>

  <main id="content">
    <div class="card">
      <h2>Bienvenido a Revival Hub</h2>
      <p class="muted">Reg√≠strate o inicia sesi√≥n para empezar.</p>
    </div>
  </main>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <!-- contenido admin (ban, dar robux, items, etc.) -->
  </div>

  <script>
    // === Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBwj_as6pb5Bg81F9Cl9VWTKkekMM9Exfk",
      authDomain: "pekora-forum.firebaseapp.com",
      projectId: "pekora-forum",
      storageBucket: "pekora-forum.firebasestorage.app",
      messagingSenderId: "161910967859",
      appId: "1:161910967859:web:6a28cecaae74b9b7e9dd46",
      measurementId: "G-BPBTW5KBRK"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();
    let currentUser=null;

    // === Registro/Login ===
    async function register(){
      const user=document.getElementById("user").value;
      const pass=document.getElementById("pass").value;
      if(!user||!pass) return alert("Completa los campos");
      const snap=await db.collection("users").doc(user).get();
      if(snap.exists) return alert("Usuario ya existe");
      await db.collection("users").doc(user).set({username:user,password:pass,robux:100,friends:[],requests:[]});
      alert("Registrado correctamente, inicia sesi√≥n");
    }
    async function login(){
      const user=document.getElementById("user").value;
      const pass=document.getElementById("pass").value;
      const snap=await db.collection("users").doc(user).get();
      if(!snap.exists) return alert("Usuario no existe");
      if(snap.data().password!==pass) return alert("Contrase√±a incorrecta");
      currentUser=user; localStorage.setItem("currentUser",user); startApp();
    }
    function logout(){currentUser=null;localStorage.removeItem("currentUser");location.reload();}
    window.onload=function(){const u=localStorage.getItem("currentUser");if(u){currentUser=u;startApp();}}

    async function startApp(){
      document.getElementById("authBox").classList.add("hidden");
      document.getElementById("sessionBox").classList.remove("hidden");
      document.getElementById("who").innerText=currentUser;
      if(currentUser==="ROBLOX"){document.getElementById("adminTag").classList.remove("hidden");document.getElementById("adminHint").classList.remove("hidden");}
      updateRobux();
    }
    async function updateRobux(){const snap=await db.collection("users").doc(currentUser).get();if(snap.exists)document.getElementById("robux").innerText=snap.data().robux;}

    // === Secciones ===
    function loadMarket(){document.getElementById("content").innerHTML="<div class='card'><h2>Marketplace</h2></div>";}
    function loadProfile(){document.getElementById("content").innerHTML="<div class='card'><h2>Profile</h2></div>";}
    function loadPromocodes(){document.getElementById("content").innerHTML="<div class='card'><h2>Promocodes</h2></div>";}
    function loadFriends(){document.getElementById("content").innerHTML="<div class='card'><h2>Friends</h2></div>";}

    // === Tradeos con historial ===
    async function loadTradeos(){
      if(!currentUser) return alert("Inicia sesi√≥n");
      const cont=document.getElementById('content');
      cont.innerHTML=`
        <div class="card">
          <h2>Tradeos</h2>
          <div class="row">
            <div class="col"><h3>Tus amigos</h3><div id="tradeFriends" class="muted">Cargando‚Ä¶</div></div>
            <div class="col"><h3>Trades recibidos</h3><div id="receivedTrades" class="muted">Cargando‚Ä¶</div></div>
          </div>
          <div class="card">
            <h3>Historial de trades</h3>
            <div id="tradeHistory" class="muted">Cargando‚Ä¶</div>
          </div>
        </div>`;
      renderTradeFriends();renderReceivedTrades();renderTradeHistory();
    }
    async function renderTradeFriends(){
      const box=document.getElementById('tradeFriends');
      const me=(await db.collection('users').doc(currentUser).get()).data();
      box.innerHTML=""; if(!me.friends||!me.friends.length){box.innerHTML='Sin amigos';return;}
      me.friends.forEach(u=>{const row=document.createElement('div');row.innerHTML=`${u} <button class="inline-btn" onclick="openTradeWith('${u}')">Tradear</button>`;box.appendChild(row);});
    }
    async function openTradeWith(friend){
      const cont=document.getElementById('content');
      cont.innerHTML=`
        <div class="card">
          <h2>Enviar trade a ${friend}</h2>
          <h3>Selecciona tus √≠tems</h3><div id="myInv" class="grid"></div>
          <h3>Selecciona √≠tems de ${friend}</h3><div id="friendInv" class="grid"></div>
          <button class="inline-btn" onclick="sendTrade('${friend}')">Enviar Trade</button>
        </div>`;
      const myGrid=document.getElementById('myInv');const myQs=await db.collection('users').doc(currentUser).collection('inventory').get();
      myGrid.innerHTML="";if(myQs.empty){myGrid.innerHTML='<div class="muted">No tienes √≠tems</div>';}
      myQs.forEach(d=>{const it=d.data();myGrid.innerHTML+=`<label class="item"><img src="${it.img||''}"><div><b>${it.name||'-'}</b></div><div class="muted">‚≠ê ${it.value||0}</div><input type="checkbox" class="tradeOffer" value="${d.id}"></label>`;});
      const fGrid=document.getElementById('friendInv');const fQs=await db.collection('users').doc(friend).collection('inventory').get();
      fGrid.innerHTML="";if(fQs.empty){fGrid.innerHTML='<div class="muted">Amigo sin √≠tems</div>';}
      fQs.forEach(d=>{const it=d.data();fGrid.innerHTML+=`<label class="item"><img src="${it.img||''}"><div><b>${it.name||'-'}</b></div><div class="muted">‚≠ê ${it.value||0}</div><input type="checkbox" class="tradeWant" value="${d.id}"></label>`;});
    }
    async function sendTrade(target){
      const myChecks=Array.from(document.querySelectorAll('.tradeOffer:checked')).map(c=>c.value);
      const wantChecks=Array.from(document.querySelectorAll('.tradeWant:checked')).map(c=>c.value);
      if(!myChecks.length&&!wantChecks.length) return alert("Selecciona √≠tems");
      const offerItems=[];for(const id of myChecks){const snap=await db.collection('users').doc(currentUser).collection('inventory').doc(id).get();if(snap.exists)offerItems.push({id,...snap.data()});}
      const wantItems=[];for(const id of wantChecks){const snap=await db.collection('users').doc(target).collection('inventory').doc(id).get();if(snap.exists)wantItems.push({id,...snap.data()});}
      await db.collection('users').doc(target).collection('trades').add({from:currentUser,offer:offerItems,want:wantItems,ts:Date.now()});
      alert("Trade enviado");loadTradeos();
    }
    async function renderReceivedTrades(){
      const box=document.getElementById('receivedTrades');const qs=await db.collection('users').doc(currentUser).collection('trades').get();
      box.innerHTML="";if(qs.empty){box.innerHTML='Sin trades';return;}
      qs.forEach(d=>{const tr=d.data();let html=`<div><b>De:</b> ${tr.from}</div>`;
        if(tr.offer?.length){html+=`<div><u>Te ofrece:</u><br>${tr.offer.map(it=>`${it.name} ‚≠ê${it.value}`).join('<br>')}</div>`;}
        if(tr.want?.length){html+=`<div><u>Quiere recibir:</u><br>${tr.want.map(it=>`${it.name} ‚≠ê${it.value}`).join('<br>')}</div>`;}
        const row=document.createElement('div');row.className='card';
        row.innerHTML=`${html}<button class="inline-btn" onclick="acceptTrade('${d.id}','${tr.from}')">Aceptar</button><button class="inline-btn" onclick="rejectTrade('${d.id}')">Rechazar</button>`;
        box.appendChild(row);});
    }
    async function acceptTrade(tradeId,fromUser){
      const tRef=db.collection('users').doc(currentUser).collection('trades').doc(tradeId);
      const tSnap=await tRef.get();if(!tSnap.exists)return;const tr=tSnap.data();
      const receivedItems=[];const givenItems=[];
      for(const it of tr.offer||[]){await db.collection('users').doc(currentUser).collection('inventory').add({name:it.name,img:it.img,value:it.value});await db.collection('users').doc(fromUser).collection('inventory').doc(it.id).delete();receivedItems.push(it.name);}
      for(const it of tr.want||[]){await db.collection('users').doc(fromUser).collection('inventory').add({name:it.name,img:it.img,value:it.value});await db.collection('users').doc(currentUser).collection('inventory').doc(it.id).delete();givenItems.push(it.name);}
      await db.collection("tradeHistory").add({from:fromUser,to:currentUser,offer:tr.offer||[],want:tr.want||[],givenItems,receivedItems,ts:Date.now()});
      await tRef.delete();alert("Trade aceptado");loadTradeos();
    }
    async function rejectTrade(tradeId){await db.collection('users').doc(currentUser).collection('trades').doc(tradeId).delete();alert("Trade rechazado");loadTradeos();}
    async function renderTradeHistory(){
      const box=document.getElementById('tradeHistory');const qs=await db.collection("tradeHistory").orderBy("ts","desc").limit(10).get();
      box.innerHTML="";if(qs.empty){box.innerHTML="Sin historial";return;}
      qs.forEach(d=>{const tr=d.data();const date=new Date(tr.ts).toLocaleString();const row=document.createElement("div");row.className="muted";
        row.innerHTML=`<b>${tr.from}</b> ‚Üî <b>${tr.to}</b><br>Ofreci√≥: ${(tr.offer||[]).map(it=>it.name).join(", ")||"Nada"}<br>Pidi√≥: ${(tr.want||[]).map(it=>it.name).join(", ")||"Nada"}<br><small>${date}</small><hr>`;
        box.appendChild(row);});
    }
  </script>
</body>
</html>
